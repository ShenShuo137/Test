name: 智能代码审查 (PR-Agent + CodeQL)

on:
  pull_request:
    types: [opened, reopened, ready_for_review, synchronize]
  issue_comment:
    types: [created, edited]

permissions:
  contents: read
  pull-requests: write
  issues: write
  security-events: write  # 新增：CodeQL 需要这个权限

jobs:
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Job 1: PR-Agent (AI 智能审查)
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  pr_agent_job:
    if: ${{ github.event.sender.type != 'Bot' }}
    
    runs-on: ubuntu-latest
    name: 🤖 AI智能审查 (GLM-4-Plus)
    
    steps:
      - name: PR Agent action step
        id: pragent
        uses: Codium-ai/pr-agent@main
        env:
          # ═══════════════════════════════════════════════════
          # 基础配置
          # ═══════════════════════════════════════════════════
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
          # 智谱API配置
          OPENAI_KEY: ${{ secrets.GPT_API_KEY }}
          OPENAI.API_BASE: "https://api.chatanywhere.tech/v1"
          
          # ═══════════════════════════════════════════════════
          # 模型配置
          # ═══════════════════════════════════════════════════
          config.model: "gpt-4o"
          config.fallback_models: '["gpt-4o-mini", "gpt-3.5-turbo"]'
          config.custom_model_max_tokens: "128000"
          config.language: "zh"
          
          # ═══════════════════════════════════════════════════
          # ⭐ 关键配置：启用自动工具
          # ═══════════════════════════════════════════════════
          github_action_config.auto_review: "true"
          github_action_config.auto_describe: "true"
          github_action_config.auto_improve: "true"
          
          # ⭐ 关键配置：指定触发事件（必须包含 synchronize）
          github_action_config.pr_actions: '["opened", "reopened", "ready_for_review", "synchronize"]'
          
          # ═══════════════════════════════════════════════════
          # PR审查配置
          # ═══════════════════════════════════════════════════
          pr_reviewer.require_score_review: "true"
          pr_reviewer.require_tests_review: "true"
          pr_reviewer.require_security_review: "true"
          pr_reviewer.require_estimate_effort_to_review: "true"
          pr_reviewer.inline_code_comments: "true"
          pr_reviewer.num_code_suggestions: "4"
          
          pr_reviewer.extra_instructions: >-
            请用中文进行详细代码审查
          
          # ═══════════════════════════════════════════════════
          # PR描述配置
          # ═══════════════════════════════════════════════════
          pr_description.publish_description: "true"
          pr_description.publish_labels: "true"
          pr_description.enable_ai_summary: "true"
          pr_description.extra_instructions: >-
            请用中文生成PR描述
          
          # ═══════════════════════════════════════════════════
          # 代码改进建议配置
          # ═══════════════════════════════════════════════════
          pr_code_suggestions.num_code_suggestions: "5"
          pr_code_suggestions.extra_instructions: >-
            请用中文提供具体改进建议
          
      - name: ✅ AI审查完成
        if: success()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ PR-Agent 智能审查完成！"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "🤖 使用模型: 智谱 GLM-4-Plus"
          echo "🌐 审查语言: 中文"
          echo "📊 查看PR评论获取详细审查结果"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "💬 可用命令："
          echo "  /review - 重新审查代码"
          echo "  /describe - 生成PR描述"
          echo "  /improve - 获取改进建议"
          echo "  /ask <问题> - 询问关于代码的问题"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      
      - name: ❌ AI审查失败处理
        if: failure()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "❌ PR-Agent 审查失败"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "🔍 常见问题排查："
          echo "1. 检查 Settings → Secrets → ZHIPU_API_KEY"
          echo "2. 访问 https://open.bigmodel.cn/ 查看余额"
          echo "3. 查看上方日志获取详细错误"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Job 2: CodeQL (安全扫描) ⭐ 新增的部分
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  codeql_analysis:
    # ⭐ 只在 PR 事件时运行（避免 issue_comment 时重复运行）
    if: github.event_name == 'pull_request'
    
    runs-on: ubuntu-latest
    name: 🔍 安全扫描 (CodeQL)
    
    # ⭐ 多语言支持（如果项目包含多种语言）
    strategy:
      fail-fast: false
      matrix:
        language: ['python']  
        # 如果项目有其他语言，添加到这里：
        # language: ['python', 'javascript', 'java']
    
    steps:
      # ═══════════════════════════════════════════════════
      # 步骤1: 检出代码
      # ═══════════════════════════════════════════════════
      - name: 检出代码
        uses: actions/checkout@v4
      
      # ═══════════════════════════════════════════════════
      # 步骤2: 初始化 CodeQL（完全自动，无需配置）
      # ═══════════════════════════════════════════════════
      - name: 初始化 CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          
          # ⭐ 使用扩展查询集（包含更多安全规则）
          queries: +security-and-quality
          
          # ⭐ 可选：自定义查询配置
          # config-file: ./.github/codeql/codeql-config.yml
      
      # ═══════════════════════════════════════════════════
      # 步骤3: 自动构建（Python 会自动跳过，Java 需要构建）
      # ═══════════════════════════════════════════════════
      - name: 自动构建
        uses: github/codeql-action/autobuild@v3
      
      # ═══════════════════════════════════════════════════
      # 步骤4: 执行 CodeQL 分析
      # ═══════════════════════════════════════════════════
      - name: 执行 CodeQL 分析
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"
          # ✅ 结果会自动上传到 Security → Code scanning alerts
      
      - name: ✅ 安全扫描完成
        if: success()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ CodeQL 安全扫描完成！"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "🔍 扫描范围："
          echo "  • SQL 注入漏洞"
          echo "  • XSS 跨站脚本"
          echo "  • 路径遍历攻击"
          echo "  • 命令注入"
          echo "  • 硬编码密钥"
          echo "  • 资源泄露"
          echo "  • 不安全的反序列化"
          echo ""
          echo "📊 查看结果："
          echo "  • Security → Code scanning alerts"
          echo "  • Pull request → Files changed (代码行标注)"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      
      - name: ❌ 安全扫描失败处理
        if: failure()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "❌ CodeQL 扫描失败"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "🔍 可能的原因："
          echo "1. 代码语法错误"
          echo "2. 依赖项缺失（Java 项目）"
          echo "3. 构建失败"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

  